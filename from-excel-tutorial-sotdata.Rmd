---
title: "Pivot Tables and other Excel tasks you can also do in R with Summer of Tech event data"
output: 
  html_document: 
    toc: true
    toc_float: true
---

The dataset used in this exercise is Summer of Tech 2017 event details. 

At the end of the exercise we will have an interactive tabular view of the venue capacity relative to the student registration and attendance numbers.

```{r setup, include=FALSE}
# This is the setup chunk, we are using echo=TRUE so that the code is included in the R Markdown document
knitr::opts_chunk$set(cache = TRUE, echo = TRUE)
```

## Particularly useful packages for this exercise

```{r install.packages}
# Install the package the first time you use the packages
# install.packages("tidyverse")
# install.packages("rpivotTable")
library(tidyverse)
library(rpivotTable)
```

## Import Event data

```{r download data}
# Import the "2017 event detail report.csv" 
url <- "https://raw.githubusercontent.com/R-LadiesAKL/sotdata/master/2017%20event%20detail%20report.csv"
# Use the read_csv function to download the raw data to a dataframe called eventdat
eventdat <- read_csv(url)
```

```{r structure of the data}
# Take a look at the data using a function that gives us the first rows of the data
head(eventdat)
```
It looks like there are character variables, data/time variables and numeric variables.
**Name** appears to be the specific event name and a subset of the event **Type**.

##  Format "cells" in R

In Excel we can format "cells". Which functions can we use in R?

In order to access the variables we can use a **$**. Alternatively we can use another method that joins objects and functions using a pipe **%>%**. This can be useful if we would like to use multiple functions on an object. 

```{r format}
# One R approach to rename a variable
# eventdat$Name <- eventdat$Event.name
# Or we can use dplyr rename function to rename a variable with the %>%
eventdat <- eventdat %>% 
  rename(Event.name=Name)
# Change the class of the Capacity variable using the as.numeric function
eventdat$Capacity <- as.numeric(eventdat$Capacity)
# or we can use dplyr mutate to change 1 variable
eventdat <- eventdat %>% 
  mutate(Capacity=as.numeric(Capacity))
# or we can use dplyr mutate_if to change all integer variables to numeric variables
eventdat <- eventdat %>% 
  mutate_if(is.integer,as.numeric)
```

Try typing 'as.' in the console to see what other function options are available to change formats.

Next we will look at the formatting of the variable names. 

```{r make names}
# Take a look at the column or variable names
names(eventdat)
#  We will use the make.names base R function to make syntactically valid names of the column variables for further analysis and output in R Markdown. For these names, it adds a "." to the spaces in the names
names(eventdat) <- make.names(names(eventdat))
```

For other formatting we can also format the end products (such as plots) that we create using packages, so some formatting can be package function dependent.

##  "Sort" data in R

In Excel we can sort by columns. Which functions can we use in R?

```{r arrange}
# Sort by character using arrange from dplyr. We can also pipe base R functions such as head.
eventdat %>% 
  arrange(Type) %>% 
  head()
# This also works on numeric variables, sort by year using arrange from dplyr
eventdat %>% 
  arrange(Capacity) %>% 
  head()
# Or we can arrange in descending order
eventdat %>% 
  arrange(desc(Capacity)) %>% 
  head()
```

##  Create a "formula" in R

In Excel we can create formulas in cells. Which functions can we use in R?

```{r formula}
# Create a new variable in our dataframe with mutate function from dplyr. 
eventdat <- eventdat %>% 
  mutate(Extra.seats = Capacity - Number.registered)
# Take a look at the new variable and arrange in descending order
eventdat %>% 
  arrange(desc(Extra.seats)) %>% 
  head()
```

##  Filter a "column"

In Excel we can filter by columns. Which functions can we use in R?

```{r filter}
# Filter 100 Capacity events  by using dplyr filter. Remember to use == for equals in R, whereas = is an assignment in R.
eventdat %>% 
  filter(Capacity==100) %>% 
  head()
```

##  Calculate on "columns"

In Excel we can add a calculation such as sum or a mean to a column. Which functions can we use in R?

```{r calculation}
# Sum the total event attendances 
sum(eventdat$Number.checked.in)
```

##  Create a "Pivot Table"

In Excel you can create pivot tables. Which functions can we use in R?

R packages typically have vignettes which are tutorials and worked examples using the package. Have a look at this package's [vignette](https://cran.r-project.org/web/packages/rpivotTable/vignettes/rpivotTableIntroduction.html).

We will use the rpivotTable function and add arguments to specify how we would like the pivot table to look. We will use the event **Type** as a row and **Location** as Column, with a sum of the **Extra.seats**. The type of graphic will be a heatmap.

```{r pivot}
# Create an interactive pivot table heatmap using the rpivotTable function and package
rpivotTable(eventdat,rows=c("Type"),cols=c("Location"), aggregator="Sum", vals="Extra.seats", rendererName = "Heatmap")
```
  
In the heatmap object we can filter the **Location** and even add the **Event.name** as a row to see which specific events we over or under **Capacity**. We can also change the value to the other numeric variables.

## Save the "spreadsheet"

In Excel you can save your spreadsheet. Which functions can we use in R?

```{r save}
# Save dataframe with write_csv from readr package
# write_csv(eventdat,"eventdat.csv")
```



