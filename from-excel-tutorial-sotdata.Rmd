---
title: "Pivot Tables and other Excel tasks you can also do in R with Summer of Tech event data"
output: 
  html_document: 
    toc: true
    toc_float: true
---

Run each line of code yourself or Knit to HTML to walk through this tutorial.

The dataset used in this exercise is Summer of Tech 2017 event details. 

At the end of the exercise we will have an interactive tabular view of the venue capacity relative to the student registration and attendance numbers.

```{r setup, include=FALSE}
# This is the setup chunk, we are using echo=TRUE so that the code is included in the R Markdown document
knitr::opts_chunk$set(cache = TRUE, echo = TRUE)
```

## Particularly useful packages for this exercise

```{r install.packages}
# Install the package the first time you use the packages
# install.packages("tidyverse")
# install.packages("rpivotTable")
library(tidyverse)
library(rpivotTable)
```

## Import Event data

First import the data using the read_csv function from the [readr](https://cran.r-project.org/web/packages/readr/index.html R package) which is loaded with the tidyverse, to import the raw data to a dataframe called **eventdat**.

This function will import to a data frame, which is a 2-dimensional object where contents can be different types, as default.

```{r download data}
# Import the "2017 event detail report.csv" 
url <- "https://raw.githubusercontent.com/R-LadiesAKL/sotdata/master/2017%20event%20detail%20report.csv"
# The read_csv function also produces default messages describing the parsing of columns which is converting the columns into different types.
eventdat <- read_csv(url)
```

Let's take a quick look at the **eventdat** data frame. 

In R there are some packages that are included by default; take a look at the packages available in the Global Environment drop down. One such package is called package is [base](https://stat.ethz.ch/R-manual/R-devel/library/base/html/00Index.html) which includes dim function to retrieve the dimensions, the row and column numbers.

```{r dim}
# Retrieve the number of rows and columns
dim(eventdat)
```

This is a fairly small dataframe!

Another included package is [utils](https://cran.r-project.org/web/packages/R.utils/index.html) R package which includes the str and structure functions to view the basic structure. 

```{r structure}
# Use str function to 'Compactly Display the Structure of an Arbitrary R Object'. All R objects store additional attributes to store metadata about an object. In this str function we set the give.attr to FALSE to exclude these attributes.
str(eventdat, give.attr=FALSE)
# Try running the command without the parameter...
# str(witchdat)
# Next we will use structure function to view witchdat 
structure(eventdat)
```

It looks like there are character variables, data/time variables and numeric variables.
**Name** appears to be the specific event name and a subset of the event **Type**.

##  Format "cells" in R

In Excel we can format "cells". Which functions can we use in R?

A tool for data frame data manipulation is the  [dplyr](https://cran.r-project.org/web/packages/dplyr/index.html) R package. R packages typically have vignettes which are tutorials and worked examples using the package. There is useful documentation in the [Introduction to dplyr](https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html).

In order to access the variables we can use a **$**. Alternatively we can use another method that joins objects and functions using a pipe **%>%**. This can be useful if we would like to use multiple functions on an object. 

```{r format}
# Use dplyr to rename a variable
eventdat <- eventdat %>% 
  rename(Event.name=Name)
# Perform data type conversion of the deaths variable - use dplyr mutate to change 1 variable
eventdat <- eventdat %>% 
  mutate(Capacity=as.numeric(Capacity))
# or we can use dplyr mutate_if to change all integer variables to numeric variables
eventdat <- eventdat %>% 
  mutate_if(is.integer,as.numeric)
```

Try typing 'as.' in the console to see what other function options are available to change formats.

Next we will look at the formatting of the variable names. 

```{r make names}
# Take a look at the column or variable names
names(eventdat)
#  We will use the make.names base R function to make syntactically valid names of the column variables for further analysis and output in R Markdown. For these names, it adds a "." to the spaces in the names
names(eventdat) <- make.names(names(eventdat))
# View the structure of eventdat again to see these formatting changes
str(eventdat, give.attr=FALSE)
```

For other formatting we can also format the end products (such as plots) that we create, using the functions in those R packages.

##  "Sort" data in R

In Excel we can sort by columns. Which functions can we use in R?

```{r arrange}
# Sort by character using arrange from dplyr. We can also pipe other packages functions such as head from the utils package.
eventdat %>% 
  arrange(Type) %>% 
  head()
# This also works on numeric variables, sort by year using arrange from dplyr
eventdat %>% 
  arrange(Capacity) %>% 
  head()
# Or we can arrange in descending order
eventdat %>% 
  arrange(desc(Capacity)) %>% 
  head()
```

##  Create a "formula" in R

In Excel we can create formulas in cells. Which functions can we use in R?

```{r formula}
# Create a new variable in our dataframe with mutate function from dplyr. 
eventdat <- eventdat %>% 
  mutate(Extra.seats = Capacity - Number.registered)
# Take a look at the new variable and arrange in descending order
eventdat %>% 
  arrange(desc(Extra.seats)) %>% 
  head()
```

##  Filter a "column"

In Excel we can filter by columns. Which functions can we use in R?

```{r filter}
# Filter 100 Capacity events  by using dplyr filter. Remember to use == for equals in R, whereas = is an assignment in R.
eventdat %>% 
  filter(Capacity==100) %>% 
  head()
```

##  Calculate on "columns"

In Excel we can add a calculation such as sum or a mean to a column. Which functions can we use in R?

```{r calculation}
# Sum the total events. Using sum on the column deaths is intuitively the same way of calculating this sum in Excel total event attendances 
sum(eventdat$Number.checked.in)
# Now try the dplyr summarise function
eventdat %>% 
  summarise(sum_event = sum(Number.checked.in))
```

##  Create a "Pivot Table"

In Excel you can create pivot tables. Which functions can we use in R?

R packages typically have vignettes which are tutorials and worked examples using the package. Have a look at this package's [vignette](https://cran.r-project.org/web/packages/rpivotTable/vignettes/rpivotTableIntroduction.html).

We will use the rpivotTable function and add arguments to specify how we would like the pivot table to look. We will use the event **Type** as a row and **Location** as Column, with a sum of the **Extra.seats**. The type of graphic will be a heatmap.

```{r pivot}
# Create an interactive pivot table heatmap using the rpivotTable function and package
rpivotTable(eventdat,rows=c("Type"),cols=c("Location"), aggregator="Sum", vals="Extra.seats", rendererName = "Heatmap")
```
  
In the heatmap object we can filter the **Location** and even add the **Event.name** as a row to see which specific events we over or under **Capacity**. We can also change the value to the other numeric variables.

## Save the "spreadsheet"

In Excel you can save your workbooks and spreadsheets. Which functions can we use in R?

Here are some options in R, depending on what output is needed:  

- The base R write.csv function to write to a csv file  
- The readr package in the tidyverse, includes the function write_csv, which is faster than write.csv  
- The xlsx package write.xlsx to write to an Excel workbook  


```{r save}
# Save dataframe with write_csv from readr package
write_csv(eventdat,"eventdat.csv")
```


***  


  
Thanks to Marcia Ferreira @DrMarciaFe and Chris Beltz @BeltzEcology for reviewing and providing feedback on this tutorial.
